---
title: "SpurAfrika2018"
always_allow_html: yes
output:
  html_document:
    keep_md: yes
  pdf_document: default
  word_document: default
---

``` {r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 12, fig.height = 8) # larger plot size
```

``` {r}
# Settings for created output files 
# e.g. whether to show processing code, and which variables to show
# depending on confidentiality

show.id <- c('Full.name', 'Date.of.birth')
# 'identifying' alternative is 'Full.name', 'Date.of.birth'
# 'non-identifying' alternative is 'id'

``` 

# Data import and processing

``` {r results='hide', message=FALSE, warning=FALSE}
# start necessary libraries

library(airtabler)
# airtabler required to read airtable database
# airtabler is installed by 'devtools::install_github("bergant/airtabler")'
# devtools can fail if the 'unzip' settings has not been set properly
# it can be set by 'options(unzip="unzip")'

library(tidyverse)
library(lubridate)
# data management
# time management

library(knitr)
# reproducible research and markdown library

# plotting libraries
library(ggplot2)
library(plotly)
library(webshot)
```

``` {r}
# read in data
ClinicData <- 
  airtable(
    base = 'appXwAbxa7r6bkKnO',
    tables = c('SpurAfrika2018','Schools','FindingCodes','ManagementCodes')
  )

RawPatientData <- as.tibble(ClinicData$SpurAfrika2018$select_all())
RawSchoolData <- as.tibble(ClinicData$Schools$select_all())
RawFindingCodes <- as.tibble(ClinicData$FindingCodes$select_all())
RawManagementCodes <- as.tibble(ClinicData$ManagementCodes$select_all())

# turn variable names into valid R names e.g. remove spaces
names(RawPatientData) <- make.names(names(RawPatientData))
```

## Adjust and re-calculate data

Attach variable **SchoolName** to each student.
Variable **School.Name** contains the school's database ID

Recalculate **Age.in.years** with **Data.collection.date** and **Date.of.birth**

``` {r}
# find actual school name (instead of the ID)
RawPatientData <- RawPatientData %>%
  mutate(SchoolName = RawSchoolData$SchoolName[match(School.Name,RawSchoolData$id)])

# re-calculate age in years
RawPatientData <- RawPatientData %>%
  mutate(Age.in.years = as.numeric(as.Date(Data.collection.date)-as.Date(Date.of.birth))/365)

```

## Missing data and harmonising data

List unique **Form.Grade** names 

``` {r}
unique(RawPatientData$Form.Grade)
```

Many 'unique' **Form.Grade** names are redundant, e.g. trailing spaces
Change redundant names to correct names, creating new dataframe **CorrectedPatientData**

Possibly able to consolidate Grade/Class/Form years further?

```{r}

CorrectedPatientData <- RawPatientData
  
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Baby ' & !is.na(Form.Grade)),]$Form.Grade <- 'Baby'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 4 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Class 4'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 2 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Class 2'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 6 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Class 6'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 8 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Class 8'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 4 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 4'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 5 20080120' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 5'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 5 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 5'

```

Report missing date data (**Date.of.birth** and **Data.collection.date**) and subsequently
unable to calculate **Age.in.years**.

List patients with missing data.

Summarize patients with missing data by recorded **Form.Grade**.

``` {r}

missing.dob <- sum(is.na(as.Date(CorrectedPatientData$Date.of.birth)))
missing.dateofcollection <- sum(is.na(as.Date(CorrectedPatientData$Data.collection.date)))
missing.Age <- sum(is.na(CorrectedPatientData$Age.in.years))

sprintf('Patients with missing Date of Birth: %d', missing.dob)
sprintf('Patients with missing date of data collection : %d', missing.dateofcollection)
sprintf('Patients unable to calculate age: %d', missing.Age)

CorrectedPatientData %>%
  filter(is.na(as.Date(Date.of.birth))) %>%
  select(show.id, SchoolName, Form.Grade, Height) %>%
  kable(caption = 'Patients with no recorded Date of Birth')

CorrectedPatientData %>%
  filter(is.na(as.Date(Date.of.birth))) %>%
  select(show.id, SchoolName, Form.Grade, Height) %>% 
  group_by(Form.Grade) %>% 
  summarize(n=n()) %>%
  kable(caption = 'Recorded Form.Grade of patients with no recorded Date of Birth')

```

## Average age and **Form.Grade**

Summarize mean age of patients by **Form.Grade**, for patients who have calculated **Age.in.years**

``` {r}

CorrectedPatientData %>%
  filter(!is.na(as.Date(Date.of.birth))) %>%
  select(show.id, Gender, Age.in.years, SchoolName, Form.Grade,Height) %>%
  group_by(Form.Grade) %>%
  summarize(n=n(), MeanAge = mean(Age.in.years, na.rm = TRUE)) %>%
  kable(caption = 'Mean.Age of patients with calculated age, by Form.Grade')

```


## Dubious age data

List records with unlikely age data (age 0 or less)

``` {r}

CorrectedPatientData %>%
  filter(as.integer(Age.in.years) <= 0) %>%
  select(show.id, Age.in.years, Gender, Data.collection.date, Form.Grade, Height) %>%
  kable(caption = 'Dubious dates and ages')

```

Age data corrected where simple and correctible errors have been made

``` {r warning=FALSE}
# create 'corrected' version of age data

rownames(CorrectedPatientData) <- CorrectedPatientData$id

# correct dates which have been swapped or entered into wrong column
# in many cases, the Data.collection.date was set to the Date.of.birth
CorrectedPatientData['recAtRcqyfpMuLF5r', 'Data.collection.date'] <- '2018-01-05'
CorrectedPatientData['recLsoktJir05A6Sp', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recNNUJ3D0HbVCy7P', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recR7eMWKtI2ShfOp', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recWqX7skBGuBxg5O', 'Date.of.birth'] <- '2015-11-14'
CorrectedPatientData['recWqX7skBGuBxg5O', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recyMv0vRHJ33JAZF', 'Data.collection.date'] <- '2018-01-11'
```

# Children demographics

Only plot children with known ages

``` {r}

# filter out records with dubious age data
# and only include people with age less than or equal to 18 years

FilteredAgePatientData <- CorrectedPatientData %>%
  mutate(Age.in.years = as.numeric(as.Date(Data.collection.date)-as.Date(Date.of.birth))/365) %>%
  filter(as.integer(Age.in.years) > 0 & as.integer(Age.in.years) <=18 )

# create summary of patients by age and gender (only those aged 18 or below)
p <- FilteredAgePatientData %>%
  filter(as.integer(Age.in.years)<=18) %>%
  mutate(Age = as.integer(Age.in.years)) %>%
  group_by(Age, Gender) %>%
  summarize(n = n())

TotalPatients <- sum(p$n)

MedianAge <- with(FilteredAgePatientData,median(as.numeric(Age.in.years[Age.in.years<=18])))
MeanAge <- with(FilteredAgePatientData,mean(as.numeric(Age.in.years[Age.in.years<=18])))

# ggplot version of plot
gg <- p %>%
  mutate(PlotCount = n*ifelse(Gender == 'Female',1,-1)) %>%
  ggplot(aes(x = Age, y = PlotCount, fill = Gender)) +
  geom_bar(stat = 'identity') + 
  labs(title = "Number of patients in each age group") +
  labs(x = "Age", y = "Number") +
  scale_y_discrete(labels=abs) + 
                     ### remove negative values for axis for 'negative' part of chart
  guides(fill = guide_legend(title="")) +
  theme(legend.position=c(0.8,0.5)) +
  coord_flip()

# plotly version of plot
gp <- p %>%
  spread(Gender, n) %>% # divide male and female into two different variables
  mutate(MalePlot = -Male) %>% # negative male count for 'left'-side of plot
  plot_ly(x = ~Female, y = ~Age, name = 'Female',
          type = 'bar', orientation = 'h',
          hoverinfo = 'text', 
          text = ~paste('Age: ',Age,'years<br>Number :',Female,'<br>Female')) %>%
  add_trace (x = ~MalePlot, name = 'Male',
             hoverinfo = 'text', 
             text = ~paste('Age: ',Age,'years<br>Number :',Male,'<br>Male')) %>%
  layout (xaxis = list(title='Number of children in each age group', tickmode = 'array',
                       tickvals = c(-60, -40, -20, 0, 20, 40, 60),
                       # for 'negative' number, change to absolute value
                       ticktext = c('60', '40', '20', '0', '20', '40', '60')),
          yaxis = list(title='Age'),
          barmode = 'overlay',
          title = 'Spur Afrika 2018 clinics - age of children seen',
          annotations = list(list(x = 40, y = 3, showarrow = F,
                                 text = ~paste('Total children', TotalPatients,
                                               '<br>Median age: ', sprintf('%.1f',MedianAge),
                                               '<br>Mean age: ', sprintf('%.1f',MeanAge)))))

gp

```

## Body Mass Index (BMI) vs Age Plot

Some outliers apparent in BMI, likely secondary to inaccurate weight and height data

``` {r}
FilteredAgePatientData %>%
  # need both height and weight to calculate body mass index (BMI)
  filter(!is.na(Height) & !is.na(Weight)) %>%
  # calculate BMI, which is weight divided by the square of the height
  # weight is in kilogrammes, height is in metres
  mutate(bmi = Weight/((Height/100)^2)) %>%
  plot_ly(x = ~Age.in.years, y = ~bmi, color = ~Gender,
          hoverinfo = 'text',
          text = ~paste('Age : ', sprintf('%.1f', Age.in.years),
                        '<br>BMI : ', sprintf('%.1f', bmi))) %>%
  layout(title = 'Body Mass Index (BMI) of children vs Age
         Spur Afrika Clinic, January 2018')
  
``` 

# Clinical Findings

Analyze clinical findings of children (by age **Age.in.years**). If no age is available,
assume that all patients attending school **Form.grade** are children. Store in **ChildPatientData**

Create a 'flattened' database **ChildFindingsData**, flattening the contents of **Findings**

``` {r}

ChildPatientData <- CorrectedPatientData %>%
  # either age 18 years or less, or recorded to be attending primary/middle school
  filter((Age.in.years <= 18) | (grepl('grade|class|form',Form.Grade, ignore.case = TRUE)))

sprintf('Number of children : %d', nrow(ChildPatientData))
sprintf('Includes all primary or middle school attendees, even if age not known')

ChildFindingsData <- ChildPatientData %>%
  mutate(CombinedFindings = Map(append,Findings,Findings2)) %>%
  # Findings were stored in two separate columns
  mutate(Findings = lapply(CombinedFindings,
                           function(Finding) as.data.frame(Finding, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(Findings) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(Finding = 
           RawFindingCodes$Description[match(Finding,as.character(RawFindingCodes$id))]) %>%
  # capitalize the first letter of each finding, no capitals elsewhere
  mutate(Finding = paste(toupper(substring(Finding,1,1)),
                         tolower(substring(Finding,2)), sep = ''))
```

**Clean up Findings Data**

List unique finding names

``` {r}
print(sort(unique(ChildFindingsData$Finding)))
```

Rationalize findings

``` {r echo=TRUE}
ChildFindingsData[ChildFindingsData$Finding == 'Caries',]$Finding <- 'Dental decay'
ChildFindingsData[ChildFindingsData$Finding == 'Tooth decay',]$Finding <- 'Dental decay'
ChildFindingsData[ChildFindingsData$Finding == 'Difficulty hearing',]$Finding <- 'Hearing loss'
ChildFindingsData[ChildFindingsData$Finding == 'Poor hearing',]$Finding <- 'Hearing loss'
ChildFindingsData[ChildFindingsData$Finding == 'Itchy eyes',]$Finding <- 'Eye irritation'
ChildFindingsData[ChildFindingsData$Finding == 'Mittleschmerz pain',]$Finding <- 'Mittelschmerz pain'

```

``` {r}

ChildFindingsData %>%
  group_by(Finding) %>%
  dplyr::summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Findings in children, ranked by frequency')

```

Plot findings by category

``` {r echo=TRUE}

FindingCategories <- tibble(Category = character(), Finding = character())
FindingCategories <- FindingCategories %>%
  add_row(Category = 'Respiratory',
          Finding = c('Atypical pneumonia', 'Pneumonia', 'Bronchitis',
                      'Tuberculosis', 'Productive cough', 'Cough',
                      'Lower respiratory tract infection',
                      'Upper respiratory tract infection','Dyspnoea',
                      'Asthma', 'Bronchiectasis', 'Rhonchi', 'Runny nose',
                      'Short of breath', 'Viral illness')) %>%
  add_row(Category = 'Cardiovascular',
          Finding = c('Congenital heart disease', 'Palpitations',
                      'Heart murmur', 'Tachycardia', 'Valvular heart disease')) %>%
  add_row(Category = 'Gastrointestinal',
          Finding = c('Heartburn', 'Vomiting', 'Rectal bleeding', 'Gastritis',
                      'Constipation', 'Odynophagia', 'Dysphagia',
                      'Chronic diarrhoea', 'Diarrhoea', 'Gastro-oesophageal reflux',
                      'Gastroenteritis', 'Adenitis')) %>%
  add_row(Category = 'Genito-urinary',
          Finding = c('Urinary tract infection', 'Pyelonephritis', 'Dysuria',
                      'Acute cystitis')) %>%
  add_row(Category = 'Surgical',
          Finding = c('Burn', 'Discharging wound', 'Wound', 'Abdominal pain',
                      'Soft-tissue injury', 'Congenital abnormality')) %>%
  add_row(Category = 'Musculoskeletal',
          Finding = c('Chest pain : trauma', 'Fracture', 'Knee pain',
                      'Pleuritic chest pain', 'Chest pain : non-traumatic',
                      'Chest pain', 'Orthopaedic deformity', 'Joint pain',
                      'Musculoskeletal pain', 'Back pain', 'Elbow pain',
                      'Foot pain', 'Jaw pain', 'Neck pain', 'Trauma',
                      'Prosthetic limb', 'Repetitive strain injury')) %>%
  add_row(Category = 'Allergy',
          Finding = c('Allergy', 'Environmental irritant', 'Food intolerance')) %>%
  add_row(Category = 'Gynaecology',
          Finding = c('Menstruation not yet started', 'Menstrual period missed',
                      'Sexual development variation', 'Dysmenorrhoea',
                      'Mittelschmerz pain', 'Pre-menstrual pain')) %>%
  add_row(Category = 'Oral health',
          Finding = c('Periodontal infection', 'Dental overcrowding',
                      'Dental calculus', 'Dental plaque', 'Dental decay',
                      'Dental pain', 'Oral health poor', 'Gingivitis',
                      'Caries', 'Jaw and temperomandibular joint pain',
                      'Bleeding gums', 'Gum pain', 'Tooth broken',
                      'Tooth loose', 'Tooth hypomineralization',
                      'Tooth fissures', 'Angular stomatitis',
                      'Geographical tongue', 'Gum disease', 'Halitosis',
                      'Poor oral hygiene', 'Sore tongue', 'Tongue blisters',
                      'Tooth eruption', 'Toothache', 'Toothache - cold drink or food',
                      'Toothache - eating', 'Staining')) %>%
  add_row(Category = 'Dermatology',
          Finding = c('Pruritus', 'Skin lesion', 'Chronic candidiasis - PV',
                      'Apthous ulcer', 'Cold Sore', 'Acne', 'Tinea', 'Tinea capitis',
                      'Molluscum contagiosum', 'Thrush-oral', 'Folliculitis', 'Scabies',
                      'Cellulitis', 'Scar-skin', 'Dermatitis-contact', 'Dermatitis',
                      'Dry eyelid', 'Eczema', 'Facial blemish', 'Scurvy',
                      'Rash', 'Sebaceous cyst')) %>%
  add_row(Category = 'Non-specific',
          Finding = c('Fever', 'Unconscious', 'Collapse', 'Unwell', 'Dizziness',
                      'Weakness', 'Dehydration', 'Food lack', 'Tiredness', 'Nausea',
                      'Syncope')) %>%
  add_row(Category = 'Infectious',
          Finding = c('Worms', 'Parasitic infection', 'Malaria', 'Amoebiasis',
                      'Malaria-history of')) %>%
  add_row(Category = 'Ear-Nose-Throat',
          Finding = c('Sinusitis-allergic', 'Sinusitis-infective', 'Sinusitis',
                      'Sore throat', 'Throat pain', 'Tonsillitis', 'Hearing loss',
                      'Ear wax', 'Ear pain', 'Otitis media - chronic suppurative',
                      'Otitis media-serous', 'Otitis media - acute', 'Otitis externa',
                      'Throat dryness', 'Hayfever', 'Epistaxis', 'Rhinitis',
                      'Dry nasal mucosa', 'Foreign body in ear',
                      'Nose bridge pain')) %>%
  add_row(Category = 'Opthalmology',
          Finding = c('Conjunctivitis', 'Lacrimation', 'Conjunctivitis - allergic',
                      'Corneal abrasion', 'Diplopia', 'Blindness', 'Astigmatism',
                      'Myopia', 'Eye pain', 'Eye irritation', 'Eye discharge',
                      'Eyes dry', 'Eyesight poor', 'Iritis', 'Photophobia',
                      'Strabismus')) %>%
  add_row(Category = 'Haematology',
          Finding = c('Lymphadenopathy - cervical', 'Lymphadenopathy',
                      'Coagulation disorder', 'Iron-deficiency anaemia')) %>%
  add_row(Category = 'Social spiritual psychological',
          Finding = c('Spiritual issue', 'Depression',
                      'Assault', 'Social situation risk', 'Hunger pains')) %>%
  add_row(Category = 'Neurology',
          Finding = c('Headache', 'Tension headache'))
  
ChildFindingsData <- ChildFindingsData %>%
  left_join(FindingCategories, by = 'Finding') %>%
  rename(Finding.Category = Category)

```


``` {r}
ChildFindingsData %>%
  filter(Finding != 'No complaints') %>%
  group_by(Finding.Category, Finding) %>%
  summarize(Count = n()) %>%
  plot_ly(y = ~Finding.Category, x = ~Count, type = 'bar',
          name = ~Finding, color = ~Finding,
          hoverinfo = 'text',
          text = ~paste(Finding.Category, '<br>', Finding, '<br>Count: ', Count)) %>%
  layout(barmode = 'stack', orientation = 'h', showlegend = FALSE,
         title = 'Number of children seen with each category of finding
         Spur Afrika Clinic, January 2018',
         yaxis = list(title = ''), margin = list(l=200, t=75))
```

## Dental Findings

List of dental findings in children, by frequency

``` {r}

ChildDentalFindingsData <- ChildPatientData %>%
  mutate(Dental.Finding = lapply(Dental.Finding,
                           function(Dental.Find) as.data.frame(Dental.Find, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(Dental.Finding) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(Dental.Find = 
           RawFindingCodes$Description[match(Dental.Find,as.character(RawFindingCodes$id))])

ChildDentalFindingsData %>%
  group_by(Dental.Find) %>%
  dplyr::summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Dental Findings in children, ranked by frequency')

```

# Management

``` {r}

ChildManagementData <- ChildPatientData %>%
  mutate(Management = lapply(Management,
                           function(Manage) as.data.frame(Manage, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(Management) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(Manage = 
           RawManagementCodes$Description[match(Manage,as.character(RawManagementCodes$id))])

ChildManagementData %>%
  group_by(Manage) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Management for children, ranked by frequency')
```

## Dental management

``` {r}

ChildManagementDentalData <- ChildPatientData %>%
  mutate(DentalMx = lapply(DentalMx,
                           function(DentalManage) as.data.frame(DentalManage, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(DentalMx) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(DentalManage = 
           RawManagementCodes$Description[match(DentalManage,as.character(RawManagementCodes$id))])

ChildManagementDentalData %>%
  group_by(DentalManage) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Dental Management for children, ranked by frequency')

```

