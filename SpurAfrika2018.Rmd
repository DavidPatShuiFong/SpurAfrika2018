---
title: "SpurAfrika2018"
author: David Fong
date: March 21, 2018
always_allow_html: yes
output:
#  ioslides_presentation
  html_document:
    keep_md: yes
  pdf_document: default
  word_document: default
---

# Synopsis

Summary statistics and Exploratory analysis of Spur Afrika Clinic activity in Kibera, January 2018.

``` {r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# knitr::opts_chunk$set(fig.width = 7, fig.height = 7) # plot size

modifying_code_echo = FALSE # echo code that modifies data?
print_tables = 'hide'

```

``` {r}
# Settings for created output files 
# e.g. whether to show processing code, and which variables to show
# depending on confidentiality

show.id <- c('Full.name','Date.of.birth')
# 'identifying' alternative is 'Full.name', 'Date.of.birth'
# 'non-identifying' alternative is 'id'

``` 

# Data import and processing

Data collected by Spur Afrika medical team, local Kenyan
medical staff and Australian guests, working in 
Kibera, Nairobi, Kenya.

Data imported from Airtable, 'cloud database'

``` {r results='hide', message=FALSE, warning=FALSE}
# start necessary libraries

library(airtabler)
# airtabler required to read airtable database
# airtabler is installed by 'devtools::install_github("bergant/airtabler")'
# devtools can fail if the 'unzip' settings has not been set properly
# it can be set by 'options(unzip="unzip")'

library(tidyverse)
library(lubridate)
# data management
# time management

library(broom)
# converts statistic analysis objects into tidy dataframes

library(knitr)
# reproducible research and markdown library

# plotting libraries
library(ggplot2)
library(plotly)
library(RColorBrewer)
library(webshot)
```


``` {r}
# Patient data stored in **RawPatientData**. Information in **RawPatientData** is coded, the coding is contained in other tables as follows:

## School name data stored in **RawSchoolData**
## Finding/diagnosis codes stored in **RawFindingCodes**
## Management/treatment codes stored in *RawManagementCodes**

# read in data
ClinicData <- 
  airtable(
    base = 'appXwAbxa7r6bkKnO',
    tables = c('SpurAfrika2018','Schools','FindingCodes','ManagementCodes')
  )

RawPatientData <- as.tibble(ClinicData$SpurAfrika2018$select_all())
RawSchoolData <- as.tibble(ClinicData$Schools$select_all())
RawFindingCodes <- as.tibble(ClinicData$FindingCodes$select_all())
RawManagementCodes <- as.tibble(ClinicData$ManagementCodes$select_all())

# turn variable names into valid R names e.g. remove spaces
names(RawPatientData) <- make.names(names(RawPatientData))
```

``` {r}
# read in Stature, Weight and BMI percentile calculation charts
StatForAge <- list(Female =as.tibble(read.csv('StatForAgeF.csv')),
                   Male = as.tibble(read.csv('StatForAgeM.csv')))
```

``` {r}
## Adjust and re-calculate data

# Attach variable **SchoolName** to each student.
# Variable **School.Name** contains the school's database ID
# Recalculate **Age.in.years** with **Data.collection.date** and **Date.of.birth**

# find actual school name (instead of the ID)
RawPatientData <- RawPatientData %>%
  mutate(SchoolName = RawSchoolData$SchoolName[match(School.Name,RawSchoolData$id)])

# re-calculate age in years
RawPatientData <- RawPatientData %>%
  mutate(Age.in.years = as.numeric(as.Date(Data.collection.date)-as.Date(Date.of.birth))/365)

```

## Missing data and harmonising data

``` {r results=print_tables}
print('List unique **Form.Grade**')
unique(RawPatientData$Form.Grade)
```

Redundant grade names consolidated

```{r}
# Many 'unique' **Form.Grade** names are redundant, e.g. trailing spaces.
# Change redundant names to correct names, creating new dataframe **CorrectedPatientData**
# A comparison of mean ages in 'Class X' with 'Grade X' revealed almost identical mean ages and progression in ages
# -> merge 'Class X' to 'Grade X'

CorrectedPatientData <- RawPatientData
  
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Baby ' & !is.na(Form.Grade)),]$Form.Grade <- 'Baby'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 1' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 1'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 2' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 2'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 2 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 2'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 3' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 3'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 4' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 4'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 4 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 4'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 4' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 4'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 4 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 4'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 5' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 5'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 5 20080120' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 5'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 5 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 5'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 6' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 6'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Grade 6 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 6'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 7' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 7'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 8' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 8'
CorrectedPatientData[with(CorrectedPatientData,Form.Grade == 'Class 8 ' & !is.na(Form.Grade)),]$Form.Grade <- 'Grade 8'

```

``` {r results=print_tables}

print ('Report missing date data (**Date.of.birth** and **Data.collection.date**) and subsequently unable to calculate **Age.in.years**.')
print ('List patients with missing data.')
print ('Summarize patients with missing data by recorded **Form.Grade**.')

missing.dob <- sum(is.na(as.Date(CorrectedPatientData$Date.of.birth)))
missing.dateofcollection <- sum(is.na(as.Date(CorrectedPatientData$Data.collection.date)))
missing.Age <- sum(is.na(CorrectedPatientData$Age.in.years))

sprintf('Patients with missing Date of Birth: %d', missing.dob)
sprintf('Patients with missing date of data collection : %d', missing.dateofcollection)
sprintf('Patients unable to calculate age: %d', missing.Age)

CorrectedPatientData %>%
  filter(is.na(as.Date(Date.of.birth))) %>%
  select(show.id, SchoolName, Form.Grade, Height) %>%
  head() %>% # there are lots of patients without date of birth data
  kable(caption = '(shortened list of) Patients with no recorded Date of Birth')

CorrectedPatientData %>%
  filter(is.na(as.Date(Date.of.birth))) %>%
  select(show.id, SchoolName, Form.Grade, Height) %>% 
  group_by(Form.Grade) %>% 
  summarize(n=n()) %>%
  kable(caption = 'Recorded Form.Grade of patients with no recorded Date of Birth')

```

## Average age and **Form.Grade**

``` {r fig.align='center', warning=FALSE}
# Summarize mean age of patients by **Form.Grade**, for patients who have calculated **Age.in.years**

p <- CorrectedPatientData %>%
  filter(!is.na(as.Date(Date.of.birth))) %>%
  select(show.id, Gender, Age.in.years, SchoolName, Form.Grade,Height) %>%
  group_by(Form.Grade) %>%
  summarize(n=n(), MeanAge = mean(Age.in.years, na.rm = TRUE)) %>%
  plot_ly(x = ~Form.Grade, y = ~MeanAge, type = 'bar',
          hoverinfo = 'text',
          text = ~paste('Grade: ', Form.Grade, '<br>Mean: ', MeanAge, ' years','<br>Number :' ,n)) %>%
  layout(title = 'Average age in each school year',
         xaxis = list(title = 'Grade'),
         yaxis = list(title = 'Mean age (in years)'),
         margin = list(b = 75))
  # kable(caption = 'Mean.Age of patients with calculated age, by Form.Grade')

suppressWarnings(p)

```


## Dubious age data

``` {r results=print_tables}

print('List records with unlikely age data (age 0 or less')

CorrectedPatientData %>%
  filter(as.integer(Age.in.years) <= 0) %>%
  select(show.id, Age.in.years, Gender, Data.collection.date, Form.Grade, Height) %>%
  kable(caption = 'Dubious dates and ages')

```

Age data corrected where simple and correctible errors have been made

``` {r warning=FALSE, echo=modifying_code_echo}
# create 'corrected' version of age data

rownames(CorrectedPatientData) <- CorrectedPatientData$id

# correct dates which have been swapped or entered into wrong column
# in many cases, the Data.collection.date was set to the Date.of.birth
CorrectedPatientData['recAtRcqyfpMuLF5r', 'Data.collection.date'] <- '2018-01-05'
CorrectedPatientData['recLsoktJir05A6Sp', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recNNUJ3D0HbVCy7P', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recR7eMWKtI2ShfOp', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recWqX7skBGuBxg5O', 'Date.of.birth'] <- '2015-11-14'
CorrectedPatientData['recWqX7skBGuBxg5O', 'Data.collection.date'] <- '2018-01-11'
CorrectedPatientData['recyMv0vRHJ33JAZF', 'Data.collection.date'] <- '2018-01-11'

# remove some unlikely dates of birth
CorrectedPatientData['recWqX7skBGuBxg5O', 'Date.of.birth'] <- NA
# born 2015-11-14, but in 2018 already 29 kg and 145 cm tall, and Grade 7
CorrectedPatientData['recfCemBktJieY9tO', 'Date.of.birth'] <- NA
# born 2016-01-31, but in 2018 already 35 kg and 148 cm tall, and Grade 6
CorrectedPatientData['recvU9arOYkcoBw7H', 'Date.of.birth'] <- NA
# born 2015-01-01, but in 2018 already 40 kg and 151 cm tall, and Class 4


```

## Height data


``` {r warning=FALSE, echo=modifying_code_echo}
# Remove some unlikely height recordings.

# some impossible or unlikely heights
CorrectedPatientData['recQBdegQTVTI1vql', 'Height'] <- NA 
# contact above had a height recording of 1236 cm
CorrectedPatientData['recZcyQJKTRz5ldph', 'Height'] <- NA 
# contact above had a height recording of 77 cm, weight 23 kg, age 7 years, female
CorrectedPatientData['receHuzCheQwGEzAv', 'Height'] <- NA 
# contact above had a height recording of 71 cm, weight 20 kg, age 7 years, male
CorrectedPatientData['recdQJEnAkpwFJoXO', 'Height'] <- NA 
# contact above had a height recording of 98 cm, weight 28 kg, age 10 years, female
CorrectedPatientData['recqtBsxk3BTILa85', 'Height'] <- NA 
# contact above had a height recording of 166 cm, weight 18 kg, age 6 years, female
CorrectedPatientData['recdQJEnAkpwFJoXO', 'Height'] <- NA
# contact above had a height recording of 98 cm, weight 28 kg, age 10 years, female

p <- CorrectedPatientData %>%
  filter(!is.na(Height)) %>%
  plot_ly(y = ~Height, color = ~Gender, type = "box") %>%
  layout (title = 'Recorded heights, unlikely data removed',
          yaxis = list(title = 'Height (cm)'))

suppressWarnings(p) # necessary, because ColorBrewer complains that minimum 3 colours required

```

## Weight data

``` {r warning=FALSE}
# Boxplot of weight recordings.
# No weight recordings appear extremely unlikely on first inspection

p <- CorrectedPatientData %>%
  filter(!is.na(Weight)) %>%
  plot_ly(y = ~Weight, color = ~Gender, type = "box") %>%
  layout(title = 'Recorded weights',
         yaxis = list(title = 'Weight (kg)'))

suppressWarnings(p) # necessary, because ColorBrewer complains that 3 colours are the minimum

```

# Children demographics

## Age-Sex pyramid

``` {r warning=FALSE}

# filter out records with dubious age data
# and only include people with age less than or equal to 18 years

FilteredAgePatientData <- CorrectedPatientData %>%
  mutate(Age.in.years = as.numeric(as.Date(Data.collection.date)-as.Date(Date.of.birth))/365) %>%
    mutate(Age.in.months = as.numeric(Age.in.years*12)) %>%
  filter(as.integer(Age.in.years) > 0 & as.integer(Age.in.years) <=18 )

# create summary of patients by age and gender (only those aged 18 or below)
p <- FilteredAgePatientData %>%
  filter(as.integer(Age.in.years)<=18) %>%
  mutate(Age = as.integer(Age.in.years)) %>%
  group_by(Age, Gender) %>%
  summarize(n = n())

TotalPatients <- sum(p$n)

MedianAge <- with(FilteredAgePatientData,median(as.numeric(Age.in.years[Age.in.years<=18])))
MeanAge <- with(FilteredAgePatientData,mean(as.numeric(Age.in.years[Age.in.years<=18])))

# ggplot version of plot
gg <- p %>%
  mutate(PlotCount = n*ifelse(Gender == 'Female',1,-1)) %>%
  ggplot(aes(x = Age, y = PlotCount, fill = Gender)) +
  geom_bar(stat = 'identity') + 
  labs(title = "Number of patients in each age group") +
  labs(x = "Age", y = "Number") +
  scale_y_discrete(labels=abs) + 
                     ### remove negative values for axis for 'negative' part of chart
  guides(fill = guide_legend(title="")) +
  theme(legend.position=c(0.8,0.5)) +
  coord_flip()

# plotly version of plot
gp <- p %>%
  spread(Gender, n) %>% # divide male and female into two different variables
  mutate(MalePlot = -Male) %>% # negative male count for 'left'-side of plot
  plot_ly(x = ~Female, y = ~Age, name = 'Female',
          type = 'bar', orientation = 'h',
          hoverinfo = 'text', 
          text = ~paste('Age: ',Age,'years<br>Number :',Female,'<br>Female')) %>%
  add_trace (x = ~MalePlot, name = 'Male',
             hoverinfo = 'text', 
             text = ~paste('Age: ',Age,'years<br>Number :',Male,'<br>Male')) %>%
  layout (xaxis = list(title='Number of children in each age group', tickmode = 'array',
                       tickvals = c(-60, -40, -20, 0, 20, 40, 60),
                       # for 'negative' number, change to absolute value
                       ticktext = c('60', '40', '20', '0', '20', '40', '60')),
          yaxis = list(title='Age'),
          barmode = 'overlay',
          title = 'Spur Afrika 2018 clinics - age of children seen',
          annotations = list(list(x = 40, y = 3, showarrow = F,
                                 text = ~paste('Total children', TotalPatients,
                                               '<br>Median age: ', sprintf('%.1f',MedianAge),
                                               '<br>Mean age: ', sprintf('%.1f',MeanAge)))))

gp

```

## Height vs Age Plot

``` {r}

FilteredAgePatientData <- FilteredAgePatientData %>%
  # StatForAgeRow refers to the row number in the StatForAge[[Gender]]
  mutate(StatForAgeRows = mapply(function(months, gender) {
    as.numeric(cut(months, StatForAge[[gender]]$StatForAge, include.lowest = TRUE, right = FALSE))
    },
    Age.in.months, Gender)) %>%
  mutate(Lstat = mapply(function(row, gender, months) {
    l <- StatForAge[[gender]][row,'L']
    # interpolate between the 'L' value for the 'month below' and the 'month above'
    l <- l + 
      ((months - StatForAge[[gender]][row,'StatForAge']) / 
         (StatForAge[[gender]][row+1,'StatForAge'] - StatForAge[[gender]][row,'StatForAge'])) *
      (StatForAge[[gender]][row+1,'L'] - StatForAge[[gender]][row,'L'])
    return (l)
    },
    StatForAgeRows, Gender, Age.in.months)) %>%
  mutate(Mstat = mapply(function(row, gender, months) {
    m <- StatForAge[[gender]][row,'M']
    # interpolate between the 'M' value for the 'month below' and the 'month above'
    m <- m + 
      ((months - StatForAge[[gender]][row,'StatForAge']) / 
         (StatForAge[[gender]][row+1,'StatForAge'] - StatForAge[[gender]][row,'StatForAge'])) *
      (StatForAge[[gender]][row+1,'M'] - StatForAge[[gender]][row,'M'])
    return (m)
    },
    StatForAgeRows, Gender, Age.in.months)) %>%
  mutate(Sstat = mapply(function(row, gender, months) {
    s <- StatForAge[[gender]][row,'S']
    # interpolate between the 'S' value for the 'month below' and the 'month above'
    s <- s + 
      ((months - StatForAge[[gender]][row,'StatForAge']) / 
         (StatForAge[[gender]][row+1,'StatForAge'] - StatForAge[[gender]][row,'StatForAge'])) *
      (StatForAge[[gender]][row+1,'S'] - StatForAge[[gender]][row,'S'])
    return (s)
    },
    StatForAgeRows, Gender, Age.in.months)) %>%
  # Z-score
  mutate(Zstat = ((Height/as.numeric(Mstat))^as.numeric(Lstat)-1)/(as.numeric(Lstat) * as.numeric(Sstat))) %>%
  # percentile
  mutate(Pstat = pnorm(Zstat))

```

``` {r}

# calculate Loess smoother with uncertainty bounds
mf <- loess(Zstat ~ Age.in.years,
            data = FilteredAgePatientData[!is.na(FilteredAgePatientData$Age.in.years) &
              !is.na(FilteredAgePatientData$Height) & FilteredAgePatientData$Gender == 'Female',])
mm <- loess(Zstat ~ Age.in.years,
            data = FilteredAgePatientData[!is.na(FilteredAgePatientData$Age.in.years) &
              !is.na(FilteredAgePatientData$Height) & FilteredAgePatientData$Gender == 'Male',])

p1 <- FilteredAgePatientData %>%
  filter(!is.na(Height) & !is.na(Age.in.years)) %>%
  filter(Gender == 'Female') %>%
  plot_ly(x = ~Age.in.years, color = I('red')) %>%
  add_markers(y = ~Zstat,
          type = 'scatter', mode = 'markers', name = ~'Female',
          hoverinfo = 'text',
          text = ~paste('Age : ', sprintf('%.1f', Age.in.years),
                        '<br>Height :', sprintf('%.1f', Height),
                        '<br>Height-z : ', sprintf('%.1f', Zstat),
                        '<br>Height-% : ', sprintf('%.0f', Pstat*100),
                        '<br>ID :',id)) %>%
  add_lines(y = ~fitted(loess(Zstat ~ Age.in.years)),
            line = list(color = 'rgba(7,164,181,1)'),
            showlegend = FALSE) %>%
  add_ribbons(data = augment(mf),
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7,164,181,0.05)'),
              fillcolor = 'rgba(7,164,181,0.2)',
              showlegend = FALSE) %>% 
  layout(title = 'Height (z-score) vs Age
         Spur Afrika Clinic, January 2018',
         xaxis = list(title = 'Age in years'),
         yaxis = list(title = 'Height (z-score)'))

p2 <- FilteredAgePatientData %>%
  filter(!is.na(Height) & !is.na(Age.in.years)) %>%
  filter(Gender == 'Male') %>%
  plot_ly(x = ~Age.in.years, color=I('blue')) %>%
  add_markers(y = ~Zstat,
          type = 'scatter', mode = 'markers', name = ~'Male',
          hoverinfo = 'text',
          text = ~paste('Age : ', sprintf('%.1f', Age.in.years),
                        '<br>Height :', sprintf('%.1f', Height),
                        '<br>Height-z : ', sprintf('%.1f', Zstat),
                        '<br>Height-% : ', sprintf('%.0f', Pstat*100),
                        '<br>ID :',id)) %>%
  add_lines(y = ~fitted(loess(Zstat ~ Age.in.years)),
            line = list(color = 'rgba(7,164,181,1)'),
            showlegend = FALSE) %>%
  add_ribbons(data = augment(mm),
            ymin = ~.fitted - 1.96 * .se.fit,
            ymax = ~.fitted + 1.96 * .se.fit,
            line = list(color = 'rgba(7,164,181,0.05)'),
            fillcolor = 'rgba(7,164,181,0.2)',
            showlegend = FALSE) %>% 
  layout(title = 'Height (z-score) vs Age
         Spur Afrika Clinic, January 2018',
         xaxis = list(title = 'Age in years'),
         yaxis = list(title = 'Height (z-score)'))

p <- subplot(p1, p2, shareY = TRUE, titleX = TRUE)

suppressWarnings(p)

```


## Body Mass Index (BMI) vs Age Plot

``` {r warning=FALSE}
# Some outliers apparent in BMI, likely secondary to inaccurate weight and height data.

p <- FilteredAgePatientData %>%
  # need both height and weight to calculate body mass index (BMI)
  filter(!is.na(Height) & !is.na(Weight)) %>%
  # calculate BMI, which is weight divided by the square of the height
  # weight is in kilogrammes, height is in metres
  mutate(bmi = Weight/((Height/100)^2)) %>%
  plot_ly(x = ~Age.in.years, y = ~bmi, color = ~Gender,
          type = 'scatter', mode = 'markers',
          hoverinfo = 'text',
          text = ~paste('Age : ', sprintf('%.1f', Age.in.years),
                        '<br>BMI : ', sprintf('%.1f', bmi),
                        '<br>ID :',id)) %>%
  layout(title = 'Body Mass Index (BMI) of children vs Age
         Spur Afrika Clinic, January 2018',
         xaxis = list(title = 'Age in years'),
         yaxis = list(title = 'Body mass index (kg/m<sup>2</sup>)'))

suppressWarnings(p)
  
``` 

# Clinical Findings

Analyze clinical findings of children (by age **Age.in.years**). If no age is available,
assume that all patients attending school **Form.grade** are children.

``` {r results=print_tables}
# Child patient data stored in **ChildPatientData**
# Create a 'flattened' database **ChildFindingsData**, flattening the contents of **Findings**

ChildPatientData <- CorrectedPatientData %>%
  # either age 18 years or less, or recorded to be attending primary/middle school
  filter((Age.in.years <= 18) | (grepl('grade|class|form',Form.Grade, ignore.case = TRUE)))

sprintf('Number of children : %d', nrow(ChildPatientData))
sprintf('Includes all primary or middle school attendees, even if age not known')

ChildFindingsData <- ChildPatientData %>%
  mutate(CombinedFindings = Map(append,Findings,Findings2)) %>%
  # Findings were stored in two separate columns
  mutate(Findings = lapply(CombinedFindings,
                           function(Finding) as.data.frame(Finding, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(Findings) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(Finding = 
           RawFindingCodes$Description[match(Finding,as.character(RawFindingCodes$id))]) %>%
  # capitalize the first letter of each finding, no capitals elsewhere
  mutate(Finding = paste(toupper(substring(Finding,1,1)),
                         tolower(substring(Finding,2)), sep = ''))
```

## Clean up Findings Data

Finding types rationalized

``` {r results=print_tables}
print('List of unique finding names')
print(sort(unique(ChildFindingsData$Finding)))
```

``` {r echo=modifying_code_echo}
# 'rationalize' some finding names
ChildFindingsData[ChildFindingsData$Finding == 'Caries',]$Finding <- 'Dental decay'
ChildFindingsData[ChildFindingsData$Finding == 'Tooth decay',]$Finding <- 'Dental decay'
ChildFindingsData[ChildFindingsData$Finding == 'Difficulty hearing',]$Finding <- 'Hearing loss'
ChildFindingsData[ChildFindingsData$Finding == 'Poor hearing',]$Finding <- 'Hearing loss'
ChildFindingsData[ChildFindingsData$Finding == 'Itchy eyes',]$Finding <- 'Eye irritation'
ChildFindingsData[ChildFindingsData$Finding == 'Mittleschmerz pain',]$Finding <- 'Mittelschmerz pain'

```

``` {r results=print_tables}

ChildFindingsData %>%
  group_by(Finding) %>%
  dplyr::summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Findings in children, ranked by frequency')

```

## Findings by category

``` {r echo=modifying_code_echo}

FindingCategories <- tibble(Category = character(), Finding = character())
FindingCategories <- FindingCategories %>%
  add_row(Category = 'Respiratory',
          Finding = c('Atypical pneumonia', 'Pneumonia', 'Bronchitis',
                      'Tuberculosis', 'Productive cough', 'Cough',
                      'Lower respiratory tract infection',
                      'Upper respiratory tract infection','Dyspnoea',
                      'Asthma', 'Bronchiectasis', 'Rhonchi', 'Runny nose',
                      'Short of breath', 'Viral illness')) %>%
  add_row(Category = 'Cardiovascular',
          Finding = c('Congenital heart disease', 'Palpitations',
                      'Heart murmur', 'Tachycardia', 'Valvular heart disease')) %>%
  add_row(Category = 'Gastrointestinal',
          Finding = c('Heartburn', 'Vomiting', 'Rectal bleeding', 'Gastritis',
                      'Constipation', 'Odynophagia', 'Dysphagia',
                      'Chronic diarrhoea', 'Diarrhoea', 'Gastro-oesophageal reflux',
                      'Gastroenteritis', 'Adenitis')) %>%
  add_row(Category = 'Genito-urinary',
          Finding = c('Urinary tract infection', 'Pyelonephritis', 'Dysuria',
                      'Acute cystitis')) %>%
  add_row(Category = 'Surgical',
          Finding = c('Burn', 'Discharging wound', 'Wound', 'Abdominal pain',
                      'Soft-tissue injury', 'Congenital abnormality')) %>%
  add_row(Category = 'Musculoskeletal',
          Finding = c('Chest pain : trauma', 'Fracture', 'Knee pain',
                      'Pleuritic chest pain', 'Chest pain : non-traumatic',
                      'Chest pain', 'Orthopaedic deformity', 'Joint pain',
                      'Musculoskeletal pain', 'Back pain', 'Elbow pain',
                      'Foot pain', 'Jaw pain', 'Neck pain', 'Trauma',
                      'Prosthetic limb', 'Repetitive strain injury')) %>%
  add_row(Category = 'Allergy',
          Finding = c('Allergy', 'Environmental irritant', 'Food intolerance')) %>%
  add_row(Category = 'Gynaecology',
          Finding = c('Menstruation not yet started', 'Menstrual period missed',
                      'Sexual development variation', 'Dysmenorrhoea',
                      'Mittelschmerz pain', 'Pre-menstrual pain')) %>%
  add_row(Category = 'Oral health',
          Finding = c('Periodontal infection', 'Dental overcrowding',
                      'Dental calculus', 'Dental plaque', 'Dental decay',
                      'Dental pain', 'Oral health poor', 'Gingivitis',
                      'Caries', 'Jaw and temperomandibular joint pain',
                      'Bleeding gums', 'Gum pain', 'Tooth broken',
                      'Tooth loose', 'Tooth hypomineralization',
                      'Tooth fissures', 'Angular stomatitis',
                      'Geographical tongue', 'Gum disease', 'Halitosis',
                      'Poor oral hygiene', 'Sore tongue', 'Tongue blisters',
                      'Tooth eruption', 'Toothache', 'Toothache - cold drink or food',
                      'Toothache - eating', 'Staining')) %>%
  add_row(Category = 'Dermatology',
          Finding = c('Pruritus', 'Skin lesion', 'Chronic candidiasis - PV',
                      'Apthous ulcer', 'Cold Sore', 'Acne', 'Tinea', 'Tinea capitis',
                      'Molluscum contagiosum', 'Thrush-oral', 'Folliculitis', 'Scabies',
                      'Cellulitis', 'Scar-skin', 'Dermatitis-contact', 'Dermatitis',
                      'Dry eyelid', 'Eczema', 'Facial blemish', 'Scurvy',
                      'Rash', 'Sebaceous cyst')) %>%
  add_row(Category = 'Non-specific',
          Finding = c('Fever', 'Unconscious', 'Collapse', 'Unwell', 'Dizziness',
                      'Weakness', 'Dehydration', 'Food lack', 'Tiredness', 'Nausea',
                      'Syncope')) %>%
  add_row(Category = 'Infectious',
          Finding = c('Worms', 'Parasitic infection', 'Malaria', 'Amoebiasis',
                      'Malaria-history of')) %>%
  add_row(Category = 'Ear-Nose-Throat',
          Finding = c('Sinusitis-allergic', 'Sinusitis-infective', 'Sinusitis',
                      'Sore throat', 'Throat pain', 'Tonsillitis', 'Hearing loss',
                      'Ear wax', 'Ear pain', 'Otitis media - chronic suppurative',
                      'Otitis media-serous', 'Otitis media - acute', 'Otitis externa',
                      'Throat dryness', 'Hayfever', 'Epistaxis', 'Rhinitis',
                      'Dry nasal mucosa', 'Foreign body in ear',
                      'Nose bridge pain')) %>%
  add_row(Category = 'Opthalmology',
          Finding = c('Conjunctivitis', 'Lacrimation', 'Conjunctivitis - allergic',
                      'Corneal abrasion', 'Diplopia', 'Blindness', 'Astigmatism',
                      'Myopia', 'Eye pain', 'Eye irritation', 'Eye discharge',
                      'Eyes dry', 'Eyesight poor', 'Iritis', 'Photophobia',
                      'Strabismus')) %>%
  add_row(Category = 'Haematology',
          Finding = c('Lymphadenopathy - cervical', 'Lymphadenopathy',
                      'Coagulation disorder', 'Iron-deficiency anaemia')) %>%
  add_row(Category = 'Social spiritual psychological',
          Finding = c('Spiritual issue', 'Depression',
                      'Assault', 'Social situation risk', 'Hunger pains')) %>%
  add_row(Category = 'Neurology',
          Finding = c('Headache', 'Tension headache'))
  
ChildFindingsData <- ChildFindingsData %>%
  left_join(FindingCategories, by = 'Finding') %>%
  rename(Finding.Category = Category)

```

``` {r warning=FALSE}

getPalette <- colorRampPalette(brewer.pal(8,'Set1')) # custom palette
colourCount <- length(unique(ChildFindingsData$Finding))-1

p <- ChildFindingsData %>%
  filter(Finding != 'No complaints') %>%
  group_by(Finding.Category, Finding) %>%
  summarize(Count = n()) %>%
  arrange(Finding.Category) %>%
  plot_ly(y = ~Finding.Category, x = ~Count, type = 'bar',
          name = ~Finding, color = ~Finding,
          marker = list(color = getPalette(colourCount)),
          hoverinfo = 'text',
          text = ~paste(Finding.Category, '<br>', Finding, '<br>Count: ', Count)) %>%
  layout(barmode = 'stack', orientation = 'h', showlegend = FALSE,
         title = 'Number of children seen with each category of finding
         Spur Afrika Clinic, January 2018',
         yaxis = list(title = ''), margin = list(l=200, t=75))

suppressWarnings(p)

```

## Dental Findings

``` {r results=print_tables}

ChildDentalFindingsData <- ChildPatientData %>%
  mutate(Dental.Finding = lapply(Dental.Finding,
                           function(Dental.Find) as.data.frame(Dental.Find, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(Dental.Finding) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(Dental.Find = 
           RawFindingCodes$Description[match(Dental.Find,as.character(RawFindingCodes$id))]) %>%
  filter(!is.na(Dental.Find))

ChildDentalFindingsData %>%
  group_by(Dental.Find) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Dental Findings in children, ranked by frequency')

```

``` {r}

ChildDentalFindingsData %>%
  group_by(Dental.Find) %>%
  dplyr::summarize(n = n()) %>%
  arrange(desc(n)) %>%
  filter(!(Dental.Find %in% c('No caries', 'Good oral hygiene', 'No complaints'))) %>%
  plot_ly(labels = ~Dental.Find, values = ~n, type = 'pie',
          textposition = 'inside',
          textinfo = 'label+value') %>%
  layout(title = "Dental Findings
         Spur Afrika January 2018 clinic", margin = list(t = 75))

```

# Management

Analyze management of children in **ChildPatientData**

``` {r}
# Create a 'flattened' database **ChildManagementData**, flattening the contents of **Manage**

ChildManagementData <- ChildPatientData %>%
  mutate(Management = lapply(Management,
                           function(Manage) as.data.frame(Manage, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(Management) %>% 
  # each management has its own row, so an individual patient will be listed multiple times
  # change to descriptive management names
  mutate(Manage = 
           RawManagementCodes$Description[match(Manage,as.character(RawManagementCodes$id))])
```

## Clean up Management Data

``` {r results=print_tables}
print('List unique management names')
print(sort(unique(ChildManagementData$Manage)))
```

Management names rationalized

``` {r echo=modifying_code_echo}
ChildManagementData[ChildManagementData$Manage == 'F/U Dr in 3/7 for stool sample and ABx if ongoing diarrhoea',]$Manage <-
  'Doctor review'
ChildManagementData[ChildManagementData$Manage == 'GP Follow-up',]$Manage <- 'Doctor review'
ChildManagementData[ChildManagementData$Manage == 'GP follow-up PRN',]$Manage <- 'Doctor review'
ChildManagementData[ChildManagementData$Manage == 'Ventolin',]$Manage <- 'Salbutamol inhaler (Ventolin)'
ChildManagementData[ChildManagementData$Manage == 'X-ray',]$Manage <- 'Radiology - XR'

```

``` {r results=print_tables}
ChildManagementData %>%
  group_by(Manage) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Management for children, ranked by frequency')
```

## Management by Category

``` {r echo=modifying_code_echo}
# Add *Management.Category* to *ChildManagementData*

ManageCategories <- tibble(Category = character(), Manage = character())
ManageCategories <- ManageCategories %>%
  add_row(Category = 'Oral anti-infective',
          Manage = c('Amoxycillin', 'Cephalexin', 'Griseofulvin oral',
                     'Ketoconazole oral', 'Metronidazole', 'Flucloxacillin',
                     'Antimalarials', 'Doxycycline', 'Albendazole', 'Nystatin oral',
                     'Antibiotics', 'Terbinafine')) %>%
  add_row(Category = 'Topical cream',
          Manage = c('Clotrimazole cream (clotrimoxazole)', 'Clotrimazole/betamethasone cream',
                     'Clotrimazole/beclothemasone/gentamicin cream (bulkot mixi cream)',
                     'Benzoyl benzoate topical', 'Antifungal cream', 'Iodine wash',
                     'Facial cleanser hypoallergenic', 'Moisturiser topical', 'Vaseline topical',
                     'Topical cream', 'Hydrocortisone cream', 'Permethrin')) %>%
  add_row(Category = 'Simple analgesia',
          Manage = c('Paracetamol oral', 'Ibuprofen oral')) %>%
  add_row(Category = 'Systemic steroids',
          Manage = c('Prednisolone oral')) %>%
  add_row(Category = 'Asthma medication',
          Manage = c('Salbutamol inhaler (Ventolin)', 'Salbutamol syrup', 'Fluticasone inhaler',
                     'Spacer device for metered-dose-inhaler')) %>%
  add_row(Category = 'Topical ocular',
          Manage = c('Gentamicin eye drops', 'Dexamethasone eye drops',
                     'Chloromycetin eye drops', 'Dexamethasone/gentamicin (Dexagenta) eye drops',
                     'Ocular lubricant topical', 'Sunglasses', 'Spectacle frames supplied',
                     'Hydrocortisone eye drops')) %>%
  add_row(Category = 'Topical otic',
          Manage = c('Ear drops (not otherwise specified)', 'Antibiotic ear drops',
                     'Ciprofloxacin ear drops', 'Ear cleaning',
                     'Otorex (Paradichlorobenzene, Benzocaine, Chlorbuto')) %>%
  add_row(Category = 'Gastrointestinal',
          Manage = c('Antacid oral', 'H2 antagonist', 'Proton pump inhibitor',
                     "Laxatives, aperients", 'Buscopan', 'Metoclopramide',
                     'Ondansetron')) %>%
  add_row(Category = 'Allergy',
          Manage = c('Antihistamine oral', 'Cetirizine')) %>%
  add_row(Category = 'Instruction',
          Manage = c('Hand hygiene education', 'Water intake increase', 'Fibre intake increase',
                     'Dietary advice', 'Education - epistaxis', 'Physical therapy',
                     'Dental hygiene encouragement', 'Oral hygiene demo', 'Oral intake increase',
                     'Postural adjustment', 'Brush teeth', 'Back exercises',
                     'Food preparation advice', 'Salt water gargle', 'Wash eyes')) %>%
  add_row(Category = 'Investigation',
          Manage = c('Stool analysis', 'Helicobacter pylori testing', 'Sputum for acid fast bacilli',
                     'Radiology - XR','Radiology - CT', 'Typhoid test', 'Malaria test',
                     'Urine culture', 'Ultrasound', 'Coagulation profile', 'Echo',
                     'Full blood count', 'MRI')) %>%
  add_row(Category = 'Rehydration',
          Manage = c('Oral rehydration')) %>%
  add_row(Category = 'Immunisation',
          Manage = c('Immunisation - tetanus', 'Immunisation review')) %>%
  add_row(Category = 'Oral supplement',
          Manage = c('Iron folate syrup (Hifer)', 'Iron supplement', 'Vitamin C oral',
                     'Vitamin B12 syrup', 'Folic acid', 'Multivitamin')) %>%
  add_row(Category = 'Dental',
          Manage = c('Extraction', 'Filling', 'Scaling', 'Mouthwash')) %>%
  add_row(Category = 'Review',
          Manage = c('Eye review', 'Doctor review', 'Dental review', 'Social review',
                     'Optometrist review', 'Physiotherapy review', 'Counselling or psychology review',
                     'ENT or audiology', 'Speech therapy', 'Follow-Up', 'Specialist Follow-up')) %>%
  add_row(Category = 'Wound care',
          Manage = c('Wound dressing', 'Cyst removal', 'Elbow support', 'Irritant removal'))
  
ChildManagementData <- ChildManagementData %>%
  left_join(ManageCategories, by = 'Manage') %>%
  rename(Management.Category = Category)

```

``` {r warning=FALSE}

p <- ChildManagementData %>%
  group_by(Management.Category, Manage) %>%
  summarize(Count = n()) %>%
  arrange(Management.Category) %>%
  plot_ly(y = ~Management.Category, x = ~Count, type = 'bar',
          name = ~Manage, color = ~Manage,
          hoverinfo = 'text',
          text = ~paste(Management.Category, '<br>', Manage, '<br>Count: ', Count)) %>%
  layout(barmode = 'stack', orientation = 'h', showlegend = FALSE,
         title = 'Number of children seen with each category of management
         Spur Afrika Clinic, January 2018',
         yaxis = list(title = ''), margin = list(l=200, t=75))

suppressWarnings(p)
```

## Dental management

``` {r}

ChildManagementDentalData <- ChildPatientData %>%
  mutate(DentalMx = lapply(DentalMx,
                           function(DentalManage) as.data.frame(DentalManage, stringsAsFactors = FALSE))) %>%
  # unnest requires dataframes
  unnest(DentalMx) %>% 
  # each finding has its own row, so an individual patient will be listed multiple times
  # change to descriptive finding names
  mutate(DentalManage = 
           RawManagementCodes$Description[match(DentalManage,as.character(RawManagementCodes$id))]) %>%
  filter(!is.na(DentalManage))

ChildManagementDentalData %>%
  group_by(DentalManage) %>%
  summarize(n = n()) %>%
  arrange(desc(n)) %>%
  kable(caption = 'Dental Management for children, ranked by frequency')

```
